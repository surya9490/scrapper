// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "linux-musl-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// User's uploaded products (SKUs)
model UserProduct {
  id          Int      @id @default(autoincrement())
  sku         String?  @unique
  title       String
  description String?
  brand       String?
  category    String?
  
  // Extracted attributes
  threadCount String?
  material    String?
  size        String?
  design      String?
  color       String?
  
  // Shopify integration
  shopifyProductId String?
  shopifyVariantId String?
  currentPrice     Float?
  
  // AI embeddings for matching
  titleEmbedding String? // JSON string of embedding vector
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  // Relations
  productMappings    ProductMapping[]
  priceHistories     PriceHistory[]
  monitoringItems    MonitoringItem[]
  matchingCandidates MatchingCandidate[]
  priceAlerts        PriceAlert[]
  
  @@map("user_products")
}

// Competitor products discovered through scraping
model CompetitorProduct {
  id          Int      @id @default(autoincrement())
  title       String
  url         String   @unique
  price       Float?
  image       String?
  brand       String?
  category    String?
  
  // Extracted attributes
  threadCount String?
  material    String?
  size        String?
  design      String?
  color       String?
  
  // Competitor info
  competitorDomain String
  competitorName   String?
  
  // AI embeddings for matching
  titleEmbedding String? // JSON string of embedding vector
  imageEmbedding String? // JSON string of embedding vector
  
  // Scraping metadata
  lastScrapedAt DateTime?
  scrapingStatus String @default("active") // active, inactive, failed
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  // Relations
  productMappings ProductMapping[]
  priceHistories  PriceHistory[]
  monitoringItems MonitoringItem[]
  priceAlerts     PriceAlert[]
  
  @@map("competitor_products")
}

// Product mappings between user products and competitor products
model ProductMapping {
  id                   Int      @id @default(autoincrement())
  userProductId        Int
  competitorProductId  Int
  
  // Matching confidence and algorithm details
  matchingScore        Float    // 0.0 to 1.0
  matchingAlgorithm    String   // "title_similarity", "attribute_match", "image_similarity"
  matchingDetails      String?  // JSON string with detailed matching info
  
  // Manual review status
  status               String   @default("pending") // pending, approved, rejected
  reviewedBy           String?  // User who reviewed
  reviewedAt           DateTime?
  reviewNotes          String?
  
  // Monitoring settings
  priceMonitoringEnabled Boolean @default(false)
  monitoringFrequency    String? // "hourly", "daily", "weekly"
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  // Relations
  userProduct      UserProduct      @relation(fields: [userProductId], references: [id], onDelete: Cascade)
  competitorProduct CompetitorProduct @relation(fields: [competitorProductId], references: [id], onDelete: Cascade)
  
  @@unique([userProductId, competitorProductId])
  @@map("product_mappings")
}

// Price history for both user and competitor products
model PriceHistory {
  id                   Int      @id @default(autoincrement())
  userProductId        Int?
  competitorProductId  Int?
  
  price                Float
  currency             String   @default("USD")
  
  // Price change metadata
  previousPrice        Float?
  priceChange          Float?   // Calculated difference
  priceChangePercent   Float?   // Percentage change
  
  // Source information
  source               String   // "scraping", "shopify_sync", "manual"
  sourceUrl            String?
  
  recordedAt DateTime @default(now())
  
  // Relations
  userProduct      UserProduct?      @relation(fields: [userProductId], references: [id], onDelete: Cascade)
  competitorProduct CompetitorProduct? @relation(fields: [competitorProductId], references: [id], onDelete: Cascade)
  
  @@map("price_histories")
}

// Shopify Session model for OAuth and user management
model Session {
  id            String    @id
  shop          String
  state         String
  isOnline      Boolean   @default(false)
  scope         String?
  expires       DateTime?
  accessToken   String
  userId        BigInt?
  firstName     String?
  lastName      String?
  email         String?
  accountOwner  Boolean   @default(false)
  locale        String?
  collaborator  Boolean?  @default(false)
  emailVerified Boolean?  @default(false)
  
  @@map("sessions")
}

// Shopify store configuration
model ShopifyStore {
  id          Int      @id @default(autoincrement())
  shopDomain  String   @unique
  accessToken String
  
  // Store metadata
  storeName   String?
  storeEmail  String?
  currency    String   @default("USD")
  timezone    String?
  
  // Integration settings
  autoSyncPrices      Boolean @default(false)
  syncFrequency       String? // "hourly", "daily", "weekly"
  priceUpdateStrategy String? // "manual", "auto_approve", "auto_with_limits"
  
  // Webhooks
  webhookUrl String?
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@map("shopify_stores")
}

// Job queue for background tasks
model JobQueue {
  id          Int      @id @default(autoincrement())
  jobType     String   // "scraping", "price_monitoring", "product_matching", "shopify_sync"
  jobData     String   // JSON string with job parameters
  status      String   @default("pending") // pending, processing, completed, failed
  
  // Job metadata
  priority    Int      @default(0)
  attempts    Int      @default(0)
  maxAttempts Int      @default(3)
  
  // Timing
  scheduledAt DateTime?
  startedAt   DateTime?
  completedAt DateTime?
  
  // Results
  result      String?  // JSON string with job results
  error       String?  // Error message if failed
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@map("job_queue")
}

// CSV upload batches
model UploadBatch {
  id            Int      @id @default(autoincrement())
  filename      String
  totalRows     Int
  processedRows Int      @default(0)
  successRows   Int      @default(0)
  errorRows     Int      @default(0)
  
  // Upload type and configuration
  uploadType    String   @default("manual") // manual, competitor_urls, auto_discovery
  targetWebsite String?  // For auto-discovery: "amazon", "myntra", etc.
  
  status        String   @default("processing") // processing, completed, failed
  errors        String?  // JSON string with error details
  
  uploadedBy    String?  // User identifier
  uploadedAt    DateTime @default(now())
  completedAt   DateTime?
  
  // Relations
  monitoringJobs MonitoringJob[]
  
  @@map("upload_batches")
}

// Competitor monitoring jobs
model MonitoringJob {
  id                Int      @id @default(autoincrement())
  uploadBatchId     Int?
  
  // Job configuration
  jobName           String
  jobType           String   // "competitor_urls", "auto_discovery"
  frequency         String   // "daily", "weekly", "monthly"
  isActive          Boolean  @default(true)
  
  // Monitoring settings
  priceThreshold    Float?   // Alert when price changes by this %
  stockMonitoring   Boolean  @default(true)
  ratingMonitoring  Boolean  @default(false)
  
  // Scheduling
  nextRunAt         DateTime?
  lastRunAt         DateTime?
  
  // Statistics
  totalProducts     Int      @default(0)
  activeProducts    Int      @default(0)
  failedProducts    Int      @default(0)
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  // Relations
  uploadBatch       UploadBatch?      @relation(fields: [uploadBatchId], references: [id], onDelete: SetNull)
  monitoringItems   MonitoringItem[]
  alerts            Alert[]
  
  @@map("monitoring_jobs")
}

// Individual monitoring items (product pairs)
model MonitoringItem {
  id                Int      @id @default(autoincrement())
  monitoringJobId   Int
  userProductId     Int
  competitorProductId Int?
  
  // Item configuration
  isActive          Boolean  @default(true)
  customThreshold   Float?   // Override job threshold
  
  // Discovery metadata (for auto-discovery)
  searchQuery       String?
  targetWebsite     String?
  discoveryStatus   String?  // "pending", "found", "approved", "rejected"
  confidenceScore   Float?   // AI matching confidence
  
  // Monitoring results
  lastPrice         Float?
  lastCheckedAt     DateTime?
  checkCount        Int      @default(0)
  errorCount        Int      @default(0)
  lastError         String?
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  // Relations
  monitoringJob     MonitoringJob     @relation(fields: [monitoringJobId], references: [id], onDelete: Cascade)
  userProduct       UserProduct       @relation(fields: [userProductId], references: [id], onDelete: Cascade)
  competitorProduct CompetitorProduct? @relation(fields: [competitorProductId], references: [id], onDelete: SetNull)
  
  @@unique([monitoringJobId, userProductId, competitorProductId])
  @@map("monitoring_items")
}

// Alerts and notifications
model Alert {
  id                Int      @id @default(autoincrement())
  monitoringJobId   Int
  monitoringItemId  Int?
  
  // Alert details
  alertType         String   // "price_change", "stock_out", "competitor_lower", "scraping_failed"
  title             String
  message           String
  severity          String   @default("medium") // "low", "medium", "high", "critical"
  
  // Alert data
  oldValue          String?  // Previous price/stock status
  newValue          String?  // New price/stock status
  changePercent     Float?   // Percentage change
  
  // Status
  isRead            Boolean  @default(false)
  isResolved        Boolean  @default(false)
  resolvedAt        DateTime?
  resolvedBy        String?
  
  createdAt DateTime @default(now())
  
  // Relations
  monitoringJob     MonitoringJob     @relation(fields: [monitoringJobId], references: [id], onDelete: Cascade)
  
  @@map("alerts")
}

// AI matching candidates (for auto-discovery)
model MatchingCandidate {
  id                Int      @id @default(autoincrement())
  userProductId     Int
  
  // Candidate details
  title             String
  url               String
  price             Float?
  image             String?
  website           String   // "amazon", "myntra", etc.
  
  // Matching scores
  titleSimilarity   Float?   // 0.0 to 1.0
  priceSimilarity   Float?   // 0.0 to 1.0
  overallScore      Float    // Combined confidence score
  
  // Status
  status            String   @default("pending") // "pending", "approved", "rejected", "auto_approved"
  reviewedBy        String?
  reviewedAt        DateTime?
  
  // Metadata
  searchQuery       String?
  discoveryMethod   String?  // "title_search", "embedding_match", "category_crawl"
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  // Relations
  userProduct       UserProduct @relation(fields: [userProductId], references: [id], onDelete: Cascade)
  
  @@map("matching_candidates")
}

// Price alerts for monitoring and notifications
model PriceAlert {
  id                    String   @id @default(cuid())
  
  // Alert metadata
  type                  String   // "price_drop", "price_increase", "competitor_lower", "target_reached", "system"
  severity              String   @default("medium") // "low", "medium", "high", "critical"
  title                 String
  message               String
  
  // Related entities
  userProductId         Int?
  competitorProductId   Int?
  
  // Alert data
  currentPrice          Float?
  previousPrice         Float?
  priceChange           Float?
  priceChangePercent    Float?
  targetPrice           Float?
  
  // Notification settings
  isRead                Boolean  @default(false)
  emailSent             Boolean  @default(false)
  webhookSent           Boolean  @default(false)
  
  // Metadata
  metadata              String?  // JSON string for additional data
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  // Relations
  userProduct       UserProduct?      @relation(fields: [userProductId], references: [id], onDelete: Cascade)
  competitorProduct CompetitorProduct? @relation(fields: [competitorProductId], references: [id], onDelete: Cascade)
  
  @@map("price_alerts")
}